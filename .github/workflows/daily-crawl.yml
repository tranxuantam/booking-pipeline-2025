name: Daily Booking Pipeline (Debug Mode)
on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:
jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT: booking-project-479502
      GCP_DATASET: booking_dataset
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check requirements.txt
        run: |
          echo "=== DEBUG: Nội dung requirements.txt ==="
          cat requirements.txt
          echo "=== END DEBUG ==="

      - name: Install dependencies & Playwright
        continue-on-error: true
        run: |
          echo "=== DEBUG: Bắt đầu pip install ==="
          pip install -r requirements.txt
          echo "=== DEBUG: Pip install xong, bắt đầu Playwright ==="
          playwright install chromium --with-deps
          echo "=== DEBUG: Playwright install xong ==="

      - name: Authenticate to Google Cloud
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        env:
          GOOGLE_PROJECT_ID: ${{ env.GCP_PROJECT }}

      - name: Setup Google Cloud SDK
        continue-on-error: true
        uses: google-github-actions/setup-gcloud@v2
        env:
          GOOGLE_PROJECT_ID: ${{ env.GCP_PROJECT }}

      - name: Test bq command
        continue-on-error: true
        run: |
          echo "=== DEBUG: Test bq ls (liệt kê datasets) ==="
          bq ls
          echo "=== END TEST bq ==="

      - name: Crawl to Load raw table
        continue-on-error: true
        run: |
          echo "=== DEBUG: Bắt đầu crawler_to_bigquery.py ==="
          python crawler_to_bigquery.py
          echo "=== END CRAWL ==="
          
      - name: 1. Staging Table
        continue-on-error: true
        run: |
          echo "=== DEBUG: Chạy 1_Staging.sql ==="
          bq query --nouse_legacy_sql --replace --location=US \
            < sql/1_Staging.sql
          echo "=== END STAGING ==="

      - name: 2. Dim Hotels
        continue-on-error: true
        run: |
          echo "=== DEBUG: Chạy 2_dim_hotels.sql ==="
          bq query --nouse_legacy_sql --replace --location=US \
            < sql/2_dim_hotels.sql
          echo "=== END DIM HOTELS ==="

      - name: 3. Dim Date
        continue-on-error: true
        run: |
          echo "=== DEBUG: Chạy 3_dim_date.sql ==="
          bq query --nouse_legacy_sql --replace --location=US \
            < sql/3_dim_date.sql
          echo "=== END DIM DATE ==="

      - name: 4. Fact Table
        continue-on-error: true
        run: |
          echo "=== DEBUG: Chạy 4_fact_hotel_prices.sql ==="
          bq query --nouse_legacy_sql --replace --location=US \
            < sql/4_fact_hotel_prices.sql
          echo "=== END FACT ==="

      - name: Final Debug Summary
        run: |
          echo "=== DEBUG TỔNG KẾT: Kiểm tra tất cả bước ==="
          echo "Pipeline kết thúc - kiểm tra log trên để xem fail ở đâu!"
          echo "========================================"
